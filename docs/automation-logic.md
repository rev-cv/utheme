
[← Назад](../README.md)

---

## Описание логики извлечения картинок.

1. Рекурсивно ищутся все(!) *.html файлы в директории `spec`. Собирает из *.html файлов все картинки вместе с атрибутами (title, alt, caption). Формируется единый список всех картинок проекта.

2. Производится поиск всех изображений в директории `spec`. Найденные изображения соотносятся с изображениями заявленными в *.html файлах. Если заявленных изображений не будет найдено, скрипт прекратит дальнейшее выполнение с указанием на название картинки и html-файла в котором она определена.

3. Выявляются картинки с одинаковыми названиями. Все картинки в рамках проекта должны иметь оригинальное имя. 
Если находятся картинки с одинаковыми именами, то они переименовываются посредством добавления в конец число-буквенного кода.

4. Все собранные картинки формируются в единый список объектов:
```py
{
    'name': 'handicap-mpasket-stratigikes-d93bef22', 
    'filename_full': 'handicap-mpasket-stratigikes-d93bef22.webp', 
    'html': WindowsPath('E:/work/pack44/GR-SPORT 1-5/basketstoichima.com/spec/CL1/index.html'), 
    'seo': {
        'alt': 'Παίκτες μπάσκετ σε αγώνα με πίνακα σκορ στο βάθος', 
        'title': '', 
        'description': '', 
        'caption': ''
    }, 
    'found_images': [
        WindowsPath('E:/work/pack44/GR-SPORT 1-5/basketstoichima.com/spec/CL1/handicap-mpasket-stratigikes-d93bef22.webp')
    ], 
    'selected_image': WindowsPath('E:/work/pack44/GR-SPORT 1-5/basketstoichima.com/spec/CL1/handicap-mpasket-stratigikes-d93bef22.webp')
}
```
- `name` - название картинки без расширения и без полного пути. Используется для поиска всех картинок с таким же именем независимо от расширения.
- `filename_full` - полное имя с расширением используемое в html файле
- `html` - pathlib путь до html-файла в котором картинка используется
- `found_images` - список со всеми найденными в проекте картинками с названием `name`. Могут быть разные форматы или картинки могут располагаться в разных директориях.
- `selected_image` - выбранная картинка, которая будет использоваться в статье. Используется следующий приоритет.
    - avif - если в `found_images` находится картинка в формате avif - будет использована она
    - webp - если в `found_images` находится картинка в формате webp - будет использована она
    - IMAGES - если в `found_images` находится несколько картинок например в формате webp, то будет использована та, которая находится в папке `spec/IMAGES`

Зачем нужна дополнительная реализация функционала с директорией IMAGES? Вынесение всех изображений в отдельную папку позволяет производить пакетные операции сразу над всеми картинками проекта. Например, опскейлинг с помощью Upscayl или форматирование с помощью Imagemagick.


## Описание системы обработки статей

1. Описывается пул-рабочих директорий. Это необходимо, чтобы иметь возможность в рамках одного проекта писать скрипты выполняющие разные шаги по заполнению сайта. Например: скрипт 1 - заполнить 5 начальных страниц, скрипт 2 - заполнить дополнительные 30 страниц. Рабочие директории описываются в виде списка объектов.
```py
[
    {
        "resource": "CL1",
        'post': 1,
    },
    {
        "resource": "CL2",
        'post': 2,
    },
    {
        "resource": "ADD PAGES/about-us",
        'post': 3,
    },
    {
        "resource": "ADD PAGES/cookie-policy",
        'post': 4,
    },
]
```
- `resource` - изначально содержит либо название папки в которой лежит html-файл, либо папку и название html-файла, если в одной папке несколько html-файлов.
- `post` - не обязательный параметр содержащий ID статьи в WP. Если страница уже создана в WP и ее нужно лишь отредактировать, то ID позволяет соотнести конкретный html-файл с конкретной статьей. Если поле `post` отутствует, то в дальнейшем, когда статья будет создана, оно будет заполненным автоматически.

2. Список рабочих директорий прогоняется через разные функции, которые обогащают данными объекты статей. В итоге список содержит всю информацию необходимую для публикации статей в WP.
```py
{
    'resource': WindowsPath('E:/work/pack44/GR-SPORT 1-5/basketstoichima.com/spec/CL1/index.html'), 
    'post': 6, 
    'title': 'Χάντικαπ Μπάσκετ: Τι Είναι, Πώς Παίζεται και Στρατηγικές', 
    'description': 'Μάθε τι είναι το χάντικαπ στο μπάσκετ, πώς λειτουργεί σε NBA, Euroleague και Basket League, και ποιες στρατηγικές αυξάνουν τις πιθανότητές σου.', 
    'h1': 'Χάντικαπ Μπάσκετ: Τι Είναι, Πώς Παίζεται και Στρατηγικές για Κέρδη'
    'wp_block': "",
    'publish_at': datetime.datetime("2026-03-19 17:33:00"),
    'cat': "page+30",
}
```
- `resource` - преобразуется в путь pathlib до конкретного html-файла.
- `h1`, `title`, `description` - seo данные извлеченные из html-файла
- `wp_block` - тело статьи из html-файла сконвертированное в WP блоки для непосредственного добавления в WP сайт
- `publish_at` - дата публикации статьи. Если поле отсутствует, статья публикуется сразу.

3. Объединие объектов статей с объектами картинок. В объектах статей добавляется поле `images`. Если поле `resource` у статьи и поле `html` у картинки указывает на один и тот же html файл, то объект картинки добавляется в список картинок статьи.

4. Отложенная публикация реализована с помощью обогащения объектов статей датами публикаций.
Реализовано в `core/enrich_with_schedule.py`. Передается список объектов статей и инструкция по расчета времени публикации.
- 3d 2-3p (10-18) - публикации через три дня, от 2 до 3 публикаций в день, от 10 до 18 часов по времени сервера (UTC).
- 0d 1p (8-21) - каждый день по одной статье
- 1d 5-10p - через день мощный завал контентом.
- 7d 1p (12-13) - раз в неделю строго в обед.


## Описание системы загрузки статьи в WP

1. Загрузка картинок статей в WP.
Все форматы кроме webp и avif принудительно конвертируются в webp перед отправкой в WP.
Для всех загружаемых картинок устанавливается лимит на размер в Кб. Если размер картинки превышает лимит, то она циклично конвертируется с понижением качества до тех пор, пока размер не будет меньше лимита.

    Сделан отказ от предварительной проверки наличия уже загруженных картинок и заполненных статей в WP. Если в WP media найдена картинка со слагом идентичным названию загружаемой картинки, загрузка не игнорируется и картинка перезаписывается новой.

    Загрузка реализована в `core/wp_api:upload_article_images`. 
    Конвертация реализована в `core/convertation_images`. 

2. Загрузка статьи
Генерируется slug с помощью транслитирации и задается статье, если она не имеет категорию "Utility Pages".
Название статьи берется из H1.
В SEO полях задется title и description.
Основной картиной страницы устанавливается самая первая картинка найденная на странице.
Блоки картинок в контенте статьи заполняются ссылками на ранее загруженные картинки.


